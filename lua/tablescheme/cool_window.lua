local popup = require('plenary.popup')

local WinId
local Timer = vim.loop.new_timer()
local CurrentFrame = 1

local ValentineFrames = {
    {
        "                                 ",
        "                                 ",
        "         ####       ####         ",
        "        #######   #######        ",
        "       ######### #########       ",
        "       ###################       ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "             #######             ",
        "               ###               ",
        "                                 ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "         ####       ####         ",
        "        #######   #######        ",
        "       ######### #########       ",
        "       ###################       ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "             #######             ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
   },
    {
        "                                 ",
        "                                 ",
        "         ####       ####         ",
        "        #######   #######        ",
        "       ######### #########       ",
        "       ###################       ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "         ####       ####         ",
        "        #######   #######        ",
        "       ######### #########       ",
        "       ###################       ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
    {
        "                                 ",
        "                                 ",
        "        ######     ######        ",
        "       ######### #########       ",
        "      #####################      ",
        "      #####################      ",
        "      #####################      ",
        "       ###################       ",
        "        #################        ",
        "         ###############         ",
        "          #############          ",
        "           ###########           ",
        "            #########            ",
        "              #####              ",
        "                #                ",
        "                                 ",
        "                                 ",
        " ╭─────────────────────────────╮ ",
        " │                             │ ",
        " │         I love you          │ ",
        " │                             │ ",
        " ╰─────────────────────────────╯ ",
    },
}


function CloseMenu()
  vim.api.nvim_win_close(WinId, true)
  Timer:stop()
end

function ShowMenu(opts, cb)
    local Borders = { "─", "│", "─", "│", "╭", "╮", "╯", "╰" }
    local Width = 33
    local Height = 22 

    WinId = popup.create(opts, {
        title = ' Valentine ',
        highlight = "MyProjectWindow",
        line = math.floor(((vim.o.lines - Height) / 2) - 1),
        col = math.floor((vim.o.columns - Width) / 2) + 1,
        minwidth = Width,
        minheight = Height,
        borderchars = Borders,
        focusable = false,
        cursorline = false,
        callback = function ()
            CloseMenu()
        end
    })


    local bufnr = vim.api.nvim_win_get_buf(WinId)
    vim.api.nvim_buf_set_keymap(bufnr, "n", "q", "<cmd>lua CloseMenu()<CR>", { silent=false, noremap=true})

    Timer:start(0, 60, vim.schedule_wrap(function()
        vim.api.nvim_buf_set_lines(bufnr, 0, -1, false, ValentineFrames[CurrentFrame])

        for i, line in ipairs(ValentineFrames[CurrentFrame]) do
            for j = 1, #line do
                if line:sub(j, j) == '#' then
                    vim.api.nvim_buf_add_highlight(bufnr, -1, 'ValentineHighlight', i-1, j-1, j)
                end
            end
        end

        CurrentFrame = CurrentFrame % #ValentineFrames + 1
    end))

end

function MyMenu() 
  ShowMenu({}, {})
end

vim.cmd('highlight ValentineHighlight guifg=#FF0000 guibg=#FF0000')
